<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการป้ายราคา (Price Tag Management)</title>
    
    <!-- External Libraries: Tailwind CSS, SheetJS (for Excel), jsPDF (for PDF) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Kanit & Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        /*
         * README / INSTRUCTIONS
         * =====================
         *
         * 1. HOW TO USE:
         * - Save this entire file as `index.html`.
         * - Open it in a web browser (like Chrome, Firefox).
         * - The application is now running locally.
         *
         * 2. HOW TO REPLACE EXCEL DATA:
         * - Log in as 'admin1' or 'host1'.
         * - Go to the 'ตั้งค่า' (Settings) panel.
         * - Under 'จัดการข้อมูล' (Data Management), click 'Choose File' next to 'นำเข้า Excel' and select your .xlsx file.
         * - The app will automatically parse the columns based on the specified headers.
         * - The app looks for headers like 'Item No.', 'Description', 'Details', 'Normal Price', 'Promotion Price', 'Flagship Price / Website', 'Dealer Price', 'Marketplace Price', 'Expire Date', and 'GP%'.
         *
         * 3. HOW TO DEPLOY TO GITHUB PAGES / VERCEL:
         * - GitHub Pages:
         * a. Create a new public repository on GitHub.
         * b. Upload this `index.html` file to the repository.
         * c. Go to the repository's 'Settings' tab, then 'Pages' in the left sidebar.
         * d. Under 'Branch', select your main branch and click 'Save'.
         * e. Your site will be live at `https://<your-username>.github.io/<repository-name>/`.
         * - Vercel:
         * a. Sign up for a Vercel account and connect it to your GitHub account.
         * b. Create a new project and import the GitHub repository containing this file.
         * c. Vercel will automatically detect it's a static site. No framework preset is needed.
         * d. Click 'Deploy'. The site will be live in seconds.
         *
         * 4. DEMO CREDENTIALS:
         * - Role: Host
         * - Username: host1
         * - Password: host123
         * - Role: Admin
         * - Username: admin1
         * - Password: admin123
         * - Role: User1 (Flagship)
         * - Username: user1
         * - Password: u1pass
         * - Role: User2 (Flagship)
         * - Username: user2
         * - Password: u2pass
         * - Role: User3 (Dealer + GP%)
         * - Username: user3
         * - Password: u3pass
         * - Role: User4 (Marketplace + GP%)
         * - Username: user4
         * - Password: u4pass
        */

        /* Base theme and font styles */
        body {
            font-family: 'Kanit', 'Prompt', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #ffffff;
        }

        /* Red theme color for accents */
        .theme-red { color: #e53e3e; }
        .bg-theme-red { background-color: #e53e3e; }
        .border-theme-red { border-color: #e53e3e; }

        /* Custom dark theme styles for inputs and buttons */
        .dark-input {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #ffffff;
            border-radius: 0.375rem;
        }
        .dark-input:focus {
            outline: none;
            border-color: #e53e3e;
            box-shadow: 0 0 0 2px rgba(229, 62, 62, 0.5);
        }
        .dark-btn {
            background-color: #e53e3e;
            color: #ffffff;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .dark-btn:hover {
            background-color: #c53030;
        }
        .dark-btn-secondary {
            background-color: #4a5568;
        }
        .dark-btn-secondary:hover {
            background-color: #2d3748;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        
        /* Table styles */
        .data-table th, .data-table td {
            border-color: #4a5568;
        }
        .data-table th {
            background-color: #2d3748;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #2c2c2c;
        }
        .data-table tbody tr:hover {
            background-color: #4a5568;
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #718096; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        
        /*
         * ========================================
         * PIXEL-PERFECT PRICE TAG PRINT STYLES
         * ========================================
         * These styles are meticulously crafted to match the provided PDF/image templates.
         * They use absolute positioning and specific font sizes to ensure accuracy.
         * Units are in 'mm' for print media queries to ensure physical size is correct.
        */

        @media print {
            body, #app, .modal-backdrop {
                visibility: hidden;
                margin: 0;
                padding: 0;
                background: white;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }
            @page {
                size: A4;
                margin: 0;
            }
        }

        .print-page {
            width: 210mm;
            height: 297mm;
            page-break-after: always;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            background: white;
            display: grid;
        }
        .print-page:last-child {
            page-break-after: auto;
        }
        
        /* --- A4 Tag Layout (1 per page) --- */
        .grid-a4 { grid-template-columns: 1fr; grid-template-rows: 1fr; padding: 10mm; }
        .tag-container-a4 { width: 190mm; height: 277mm; }

        /* --- A5 Tag Layout (2 per page) --- */
        .grid-a5 { grid-template-columns: 1fr; grid-template-rows: repeat(2, 1fr); gap: 0; padding: 5mm; justify-items: center; align-items: center; }
        .tag-container-a5 { width: 148mm; height: 200mm; transform: rotate(90deg) translateX(26mm) translateY(26mm); transform-origin: center; }

        /* --- A6 Tag Layout (4 per page) --- */
        .grid-a6 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); gap: 0; padding: 5mm; justify-items: center; align-items: center; }
        .tag-container-a6 { width: 105mm; height: 148.5mm; }

        /* --- Accessories Tag Layout (12 per page) --- */
        .grid-acc { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(4, 1fr); gap: 0; padding: 7.5mm 5mm; justify-items: center; align-items: center; }
        .tag-container-acc { width: 63.3mm; height: 70mm; }

        /* --- Base Tag Styles (Shared across templates) --- */
        .price-tag {
            font-family: 'Kanit', 'Prompt', sans-serif;
            color: black;
            background-color: black;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            border-radius: 12px; /* A4 has rounded corners */
        }
        .price-tag .inner-content {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            background-color: white;
            border-radius: 8px; /* Inner content rounded corners */
            box-sizing: border-box;
            padding: 5%;
            display: flex;
            flex-direction: column;
        }
        .price-tag .logo-container {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .price-tag .logo-img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }
        .price-tag .logo-text {
            font-size: 0.8em;
            font-weight: 300;
            line-height: 1;
        }
        .price-tag .sku {
            position: absolute;
            font-weight: 500;
            color: #555;
        }
        .price-tag .description {
            font-weight: 700;
            line-height: 1.1;
            margin-top: 15%; /* Pushes content down */
        }
        .price-tag .details {
            font-weight: 400;
            line-height: 1.4;
            list-style-position: inside;
            padding-left: 0;
        }
        .price-tag .details li {
            padding-left: 0;
            text-indent: -1.2em;
            margin-left: 1.2em;
        }
        .price-tag .price-area {
            position: absolute;
            bottom: 5%;
            left: 5%;
            width: 90%;
            height: 25%;
        }
        .price-tag .expire-date {
            position: absolute;
            top: 0;
            left: 0;
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
        }
        .price-tag .normal-price {
            position: absolute;
            bottom: 35%;
            right: 0;
            color: #e53e3e;
            font-weight: 600;
            text-decoration: line-through;
        }
        .price-tag .promo-price {
            position: absolute;
            bottom: -5%;
            right: 0;
            font-weight: 700;
            color: black;
            line-height: 1;
        }
        .price-tag .main-price { /* Used when no promo price exists */
            position: absolute;
            bottom: -5%;
            right: 0;
            font-weight: 700;
            color: black;
            line-height: 1;
        }
        
        /* --- A4 Specific Styles --- */
        .tag-container-a4 .price-tag { border-radius: 20px; }
        .tag-container-a4 .inner-content { border-radius: 15px; padding: 20mm; }
        .tag-container-a4 .logo-container { top: 7%; left: 7%; height: 7%; }
        .tag-container-a4 .sku { top: 7%; right: 7%; font-size: 24pt; }
        .tag-container-a4 .description { font-size: 72pt; margin-top: 18%; }
        .tag-container-a4 .details { font-size: 28pt; margin-top: 10mm; }
        .tag-container-a4 .price-area { bottom: 8%; left: 10%; width: 80%; height: 25%; }
        .tag-container-a4 .expire-date { font-size: 26pt; }
        .tag-container-a4 .normal-price { font-size: 50pt; }
        .tag-container-a4 .promo-price, .tag-container-a4 .main-price { font-size: 120pt; }

        /* --- A6 Specific Styles --- */
        .tag-container-a6 .price-tag { border-radius: 10px; }
        .tag-container-a6 .inner-content { border-radius: 8px; padding: 8mm; }
        .tag-container-a6 .logo-container { top: 8mm; left: 8mm; height: 10mm; }
        .tag-container-a6 .sku { top: 8mm; right: 8mm; font-size: 10pt; }
        .tag-container-a6 .description { font-size: 24pt; margin-top: 12mm; }
        .tag-container-a6 .details { font-size: 11pt; margin-top: 5mm; line-height: 1.5; }
        .tag-container-a6 .price-area { bottom: 8mm; left: 8mm; width: calc(100% - 16mm); height: 30mm; }
        .tag-container-a6 .expire-date { font-size: 10pt; }
        .tag-container-a6 .normal-price { font-size: 18pt; }
        .tag-container-a6 .promo-price, .tag-container-a6 .main-price { font-size: 44pt; }
        .tag-container-a6 .logo-img { content: url('http://googleusercontent.com/file_content/1'); } /* Placeholder for logo */
        
        /* --- A5 Specific Styles (based on A6, but larger) --- */
        .tag-container-a5 .price-tag { border-radius: 15px; }
        .tag-container-a5 .inner-content { border-radius: 12px; padding: 12mm; }
        .tag-container-a5 .logo-container { top: 12mm; left: 12mm; height: 15mm; }
        .tag-container-a5 .sku { top: 12mm; right: 12mm; font-size: 14pt; }
        .tag-container-a5 .description { font-size: 36pt; margin-top: 18mm; }
        .tag-container-a5 .details { font-size: 14pt; margin-top: 8mm; line-height: 1.5; }
        .tag-container-a5 .price-area { bottom: 12mm; left: 12mm; width: calc(100% - 24mm); height: 45mm; }
        .tag-container-a5 .expire-date { font-size: 14pt; }
        .tag-container-a5 .normal-price { font-size: 28pt; }
        .tag-container-a5 .promo-price, .tag-container-a5 .main-price { font-size: 64pt; }
        .tag-container-a5 .logo-img { content: url('http://googleusercontent.com/file_content/1'); } /* Placeholder for logo */

        /* --- Accessories Tag Specific Styles --- */
        .tag-container-acc .price-tag { border: 2px solid black; border-radius: 0; }
        .tag-container-acc .inner-content { display: none; } /* No inner white box for this template */
        .tag-container-acc .acc-content {
            background: white;
            color: black;
            width: 100%;
            height: 100%;
            padding: 4mm;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .tag-container-acc .logo-container { top: 4mm; left: 4mm; height: 8mm; }
        .tag-container-acc .sku { top: 4mm; right: 4mm; font-size: 8pt; }
        .tag-container-acc .description { font-size: 11pt; margin-top: 10mm; line-height: 1.2; }
        .tag-container-acc .price-area { bottom: 4mm; left: 4mm; width: calc(100% - 8mm); height: 15mm; }
        .tag-container-acc .expire-date { font-size: 8pt; top: 2px; }
        .tag-container-acc .normal-price { font-size: 10pt; bottom: 50%; }
        .tag-container-acc .promo-price, .tag-container-acc .main-price { font-size: 20pt; bottom: 0; }
        .tag-container-acc .logo-img { content: url('http://googleusercontent.com/file_content/1'); } /* Placeholder for logo */

    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center mb-2 text-white">ระบบจัดการป้ายราคา</h1>
            <p class="text-center text-gray-400 mb-6">Price Tag Management</p>
            <div class="space-y-4">
                <input id="username" type="text" placeholder="ชื่อผู้ใช้ (Username)" class="w-full p-3 dark-input">
                <input id="password" type="password" placeholder="รหัสผ่าน (Password)" class="w-full p-3 dark-input">
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-4 h-5"></p>
            <button id="login-btn" class="w-full p-3 mt-4 dark-btn">เข้าสู่ระบบ</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 p-4 flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold">Price Tag App</h1>
            <div class="flex items-center gap-4">
                <div id="user-info" class="text-right"></div>
                <button id="settings-btn" class="px-4 py-2 dark-btn-secondary">ตั้งค่า</button>
                <button id="logout-btn" class="px-4 py-2 dark-btn">ออกจากระบบ</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 md:p-6">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-800 rounded-lg">
                <input id="search-input" type="text" placeholder="ค้นหา SKU / ชื่อสินค้า..." class="w-full p-2 dark-input lg:col-span-2">
                <input id="date-filter" type="date" class="w-full p-2 dark-input">
                <select id="channel-select" class="w-full p-2 dark-input"></select>
            </div>

            <!-- Actions -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button id="add-sku-btn" class="px-4 py-2 dark-btn">เพิ่มสินค้าใหม่</button>
                <select id="template-select" class="p-2 dark-input">
                    <option value="A4">เทมเพลต A4</option>
                    <option value="A5">เทมเพลต A5</option>
                    <option value="A6" selected>เทมเพลต A6</option>
                    <option value="Acc">เทมเพลต Accessories</option>
                </select>
                <button id="preview-btn" class="px-4 py-2 dark-btn-secondary" disabled>ดูตัวอย่าง</button>
                <button id="print-btn" class="px-4 py-2 dark-btn-secondary" disabled>พิมพ์</button>
                <button id="export-pdf-btn" class="px-4 py-2 dark-btn-secondary" disabled>ส่งออก PDF</button>
            </div>

            <!-- Product Table -->
            <div class="overflow-x-auto bg-gray-800 rounded-lg">
                <table class="w-full text-left data-table">
                    <thead class="text-xs text-gray-300 uppercase">
                        <tr>
                            <th class="p-3"><input type="checkbox" id="select-all-checkbox"></th>
                            <th class="p-3">SKU</th>
                            <th class="p-3">ชื่อสินค้า</th>
                            <th class="p-3">รายละเอียด</th>
                            <th class="p-3 text-right">ราคาปกติ</th>
                            <th class="p-3 text-right">ราคาช่องทาง</th>
                            <th class="p-3 text-right">วันหมดอายุ</th>
                            <th id="gp-header" class="p-3 text-right hidden">GP%</th>
                            <th class="p-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <button id="prev-page-btn" class="px-4 py-2 dark-btn-secondary">ก่อนหน้า</button>
                <span id="page-info"></span>
                <button id="next-page-btn" class="px-4 py-2 dark-btn-secondary">ถัดไป</button>
            </div>
        </main>
    </div>

    <!-- SKU Add/Edit Modal -->
    <div id="sku-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl m-4 overflow-y-auto max-h-[90vh]">
            <h2 id="sku-modal-title" class="text-2xl font-bold mb-4"></h2>
            <form id="sku-form" class="space-y-4">
                <input type="hidden" id="sku-id">
                <div>
                    <label for="sku-itemNo" class="block mb-1">SKU (Item No.)</label>
                    <input type="text" id="sku-itemNo" class="w-full p-2 dark-input" required>
                </div>
                <div>
                    <label for="sku-description" class="block mb-1">ชื่อสินค้า (Description)</label>
                    <input type="text" id="sku-description" class="w-full p-2 dark-input" required>
                </div>
                <div>
                    <label for="sku-details" class="block mb-1">รายละเอียด (Details) - หนึ่งข้อต่อหนึ่งบรรทัด</label>
                    <textarea id="sku-details" rows="5" class="w-full p-2 dark-input"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="sku-normal_price" class="block mb-1">ราคาปกติ</label>
                        <input type="number" id="sku-normal_price" class="w-full p-2 dark-input">
                    </div>
                    <div>
                        <label for="sku-promo_price" class="block mb-1">ราคาโปรโมชั่น</label>
                        <input type="number" id="sku-promo_price" class="w-full p-2 dark-input">
                    </div>
                    <div>
                        <label for="sku-flagship_price" class="block mb-1">ราคา Flagship</label>
                        <input type="number" id="sku-flagship_price" class="w-full p-2 dark-input">
                    </div>
                    <div>
                        <label for="sku-dealer_price" class="block mb-1">ราคา Dealer</label>
                        <input type="number" id="sku-dealer_price" class="w-full p-2 dark-input">
                    </div>
                     <div>
                        <label for="sku-marketplace_price" class="block mb-1">ราคา Marketplace</label>
                        <input type="number" id="sku-marketplace_price" class="w-full p-2 dark-input">
                    </div>
                    <div>
                        <label for="sku-expire_date" class="block mb-1">วันหมดอายุโปรโมชั่น</label>
                        <input type="date" id="sku-expire_date" class="w-full p-2 dark-input">
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-sku-btn" class="px-4 py-2 dark-btn-secondary">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 dark-btn">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Settings Panel Modal -->
    <div id="settings-panel" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl m-4 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold">ตั้งค่าระบบ</h2>
                 <button id="close-settings-btn" class="text-2xl font-bold">&times;</button>
            </div>
            <!-- Tabs -->
            <div class="border-b border-gray-700">
                <nav id="settings-tabs" class="flex space-x-4" aria-label="Tabs">
                    <!-- Tabs will be generated by JS -->
                </nav>
            </div>
            <div id="settings-content" class="pt-4">
                <!-- Data Management -->
                <div id="data-management-tab" class="space-y-4">
                    <h3 class="text-lg font-semibold">จัดการข้อมูล</h3>
                    <div class="flex items-center gap-4">
                        <label for="import-excel" class="whitespace-nowrap">นำเข้า Excel (.xlsx):</label>
                        <input type="file" id="import-excel" accept=".xlsx" class="dark-input p-2 flex-grow">
                    </div>
                    <div class="flex gap-4">
                        <button id="export-excel-btn" class="px-4 py-2 dark-btn">ส่งออกเป็น Excel</button>
                         <button id="clear-data-btn" class="px-4 py-2 bg-red-800 hover:bg-red-700 text-white font-semibold rounded-lg">ล้างข้อมูลสินค้าทั้งหมด</button>
                    </div>
                </div>
                <!-- Logo Management -->
                <div id="logo-management-tab" class="hidden space-y-4">
                     <h3 class="text-lg font-semibold">จัดการโลโก้</h3>
                     <div class="flex items-center gap-4">
                        <label for="import-logo" class="whitespace-nowrap">อัปโหลดโลโก้:</label>
                        <input type="file" id="import-logo" accept="image/*" class="dark-input p-2 flex-grow">
                    </div>
                    <div>
                        <p>ตัวอย่างโลโก้ปัจจุบัน:</p>
                        <div id="logo-preview" class="mt-2 bg-gray-700 p-4 rounded-lg h-24 flex items-center justify-center">
                            <img id="logo-preview-img" src="" alt="Logo Preview" class="max-h-full max-w-full">
                        </div>
                    </div>
                </div>
                <!-- User Management (Host only) -->
                <div id="user-management-tab" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">จัดการผู้ใช้งาน</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left data-table">
                            <thead><tr><th class="p-2">ชื่อผู้ใช้</th><th class="p-2">Role</th><th class="p-2">ช่องทางที่เห็น</th><th class="p-2">Actions</th></tr></thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                    <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-2 items-end border-t border-gray-700 pt-4">
                        <input type="text" id="new-username" placeholder="Username" class="dark-input p-2" required>
                        <input type="text" id="new-password" placeholder="Password" class="dark-input p-2" required>
                        <select id="new-role" class="dark-input p-2"></select>
                        <button type="submit" class="dark-btn p-2">เพิ่มผู้ใช้</button>
                    </form>
                </div>
                <!-- Logs -->
                <div id="logs-tab" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">ประวัติการใช้งาน</h3>
                    <button id="export-logs-csv-btn" class="px-4 py-2 dark-btn">ส่งออกเป็น CSV</button>
                    <div id="logs-container" class="bg-gray-900 p-2 rounded-lg h-64 overflow-y-auto font-mono text-sm"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-4 w-full max-w-5xl m-4 h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-2 flex-shrink-0">
                <h2 class="text-2xl font-bold">ตัวอย่างป้ายราคา</h2>
                <div class="flex items-center gap-2">
                    <button id="prev-preview-btn" class="px-3 py-1 dark-btn-secondary">&lt; ก่อนหน้า</button>
                    <span id="preview-index-info"></span>
                    <button id="next-preview-btn" class="px-3 py-1 dark-btn-secondary">ถัดไป &gt;</button>
                </div>
                <button id="close-preview-btn" class="text-3xl font-bold">&times;</button>
            </div>
            <div id="preview-content" class="flex-grow bg-gray-500 rounded flex items-center justify-center overflow-auto p-4">
                <!-- Preview tag will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Hidden area for printing -->
    <div id="print-area" class="hidden"></div>

    <!-- Main Application Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- START OF APPLICATION LOGIC ---

            // --- 1. STATE MANAGEMENT ---
            const state = {
                currentUser: null,
                users: [],
                allSkus: [],
                filteredSkus: [],
                currentPage: 1,
                itemsPerPage: 20,
                selectedSkus: new Set(),
                logs: [],
                companyLogo: null,
            };

            // --- 2. DOM ELEMENT SELECTORS ---
            const DOMElements = {
                loginScreen: document.getElementById('login-screen'),
                app: document.getElementById('app'),
                loginBtn: document.getElementById('login-btn'),
                usernameInput: document.getElementById('username'),
                passwordInput: document.getElementById('password'),
                loginError: document.getElementById('login-error'),
                userInfo: document.getElementById('user-info'),
                logoutBtn: document.getElementById('logout-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                addSkuBtn: document.getElementById('add-sku-btn'),
                productTableBody: document.getElementById('product-table-body'),
                searchInput: document.getElementById('search-input'),
                dateFilter: document.getElementById('date-filter'),
                channelSelect: document.getElementById('channel-select'),
                templateSelect: document.getElementById('template-select'),
                gpHeader: document.getElementById('gp-header'),
                prevPageBtn: document.getElementById('prev-page-btn'),
                nextPageBtn: document.getElementById('next-page-btn'),
                pageInfo: document.getElementById('page-info'),
                selectAllCheckbox: document.getElementById('select-all-checkbox'),
                previewBtn: document.getElementById('preview-btn'),
                printBtn: document.getElementById('print-btn'),
                exportPdfBtn: document.getElementById('export-pdf-btn'),
                // SKU Modal
                skuModal: document.getElementById('sku-modal'),
                skuModalTitle: document.getElementById('sku-modal-title'),
                skuForm: document.getElementById('sku-form'),
                cancelSkuBtn: document.getElementById('cancel-sku-btn'),
                // Settings Modal
                settingsPanel: document.getElementById('settings-panel'),
                closeSettingsBtn: document.getElementById('close-settings-btn'),
                settingsTabs: document.getElementById('settings-tabs'),
                settingsContent: document.getElementById('settings-content'),
                dataManagementTab: document.getElementById('data-management-tab'),
                logoManagementTab: document.getElementById('logo-management-tab'),
                userManagementTab: document.getElementById('user-management-tab'),
                logsTab: document.getElementById('logs-tab'),
                importExcel: document.getElementById('import-excel'),
                exportExcelBtn: document.getElementById('export-excel-btn'),
                clearDataBtn: document.getElementById('clear-data-btn'),
                importLogo: document.getElementById('import-logo'),
                logoPreviewImg: document.getElementById('logo-preview-img'),
                userTableBody: document.getElementById('user-table-body'),
                addUserForm: document.getElementById('add-user-form'),
                newRoleSelect: document.getElementById('new-role'),
                logsContainer: document.getElementById('logs-container'),
                exportLogsCsvBtn: document.getElementById('export-logs-csv-btn'),
                // Preview Modal
                previewModal: document.getElementById('preview-modal'),
                closePreviewBtn: document.getElementById('close-preview-btn'),
                previewContent: document.getElementById('preview-content'),
                prevPreviewBtn: document.getElementById('prev-preview-btn'),
                nextPreviewBtn: document.getElementById('next-preview-btn'),
                previewIndexInfo: document.getElementById('preview-index-info'),
                // Print Area
                printArea: document.getElementById('print-area'),
            };

            // --- 3. CONFIGURATION & CONSTANTS ---
            const ROLES = {
                HOST: 'Host',
                ADMIN: 'Admin',
                USER1: 'User1',
                USER2: 'User2',
                USER3: 'User3',
                USER4: 'User4',
            };
            
            const PERMISSIONS = {
                [ROLES.HOST]: {
                    canManageUsers: true,
                    canManageSettings: true,
                    visibleChannels: ['Flagship', 'Dealer', 'Marketplace'],
                    showGp: true, // Can see all GP if available
                },
                [ROLES.ADMIN]: {
                    canManageUsers: false,
                    canManageSettings: true,
                    visibleChannels: ['Flagship', 'Dealer', 'Marketplace'],
                    showGp: true,
                },
                [ROLES.USER1]: {
                    canManageUsers: false,
                    canManageSettings: false,
                    visibleChannels: ['Flagship'],
                    showGp: false,
                },
                [ROLES.USER2]: {
                    canManageUsers: false,
                    canManageSettings: false,
                    visibleChannels: ['Flagship'],
                    showGp: false,
                },
                [ROLES.USER3]: {
                    canManageUsers: false,
                    canManageSettings: false,
                    visibleChannels: ['Dealer'],
                    showGp: true,
                },
                [ROLES.USER4]: {
                    canManageUsers: false,
                    canManageSettings: false,
                    visibleChannels: ['Marketplace'],
                    showGp: true,
                }
            };

            // --- 4. UTILITY & HELPER FUNCTIONS ---

            /**
             * Formats a number to Thai currency format.
             * @param {number} num The number to format.
             * @returns {string} Formatted currency string.
             */
            const formatCurrency = (num) => {
                if (typeof num !== 'number' || isNaN(num)) return '-';
                return num.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            };

            /**
             * Formats a date string (e.g., YYYY-MM-DD) to DD-MM-YYYY.
             * @param {string} dateString The date string to format.
             * @returns {string} Formatted date string or empty string.
             */
            const formatDate = (dateString) => {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return '';
                    const year = date.getFullYear();
                    // Handle Excel's epoch start date issue if necessary
                    if (year < 1900) {
                        const excelDate = new Date(Date.UTC(1900, 0, dateString - 1));
                        const d = excelDate.getUTCDate().toString().padStart(2, '0');
                        const m = (excelDate.getUTCMonth() + 1).toString().padStart(2, '0');
                        const y = excelDate.getUTCFullYear();
                        return `${d}-${m}-${y}`;
                    }
                    const d = date.getDate().toString().padStart(2, '0');
                    const m = (date.getMonth() + 1).toString().padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}-${m}-${y}`;
                } catch (e) {
                    return dateString; // Return original if parsing fails
                }
            };
            
            /**
             * Logs an action to the state and localStorage.
             * @param {string} action The action performed.
             */
            const logAction = (action) => {
                const timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
                const logEntry = {
                    user: state.currentUser ? state.currentUser.username : 'System',
                    action,
                    timestamp,
                };
                state.logs.unshift(logEntry);
                localStorage.setItem('priceTagAppLogs', JSON.stringify(state.logs));
                renderLogs();
            };

            /**
             * Saves the current state to localStorage.
             */
            const saveState = () => {
                localStorage.setItem('priceTagAppUsers', JSON.stringify(state.users));
                localStorage.setItem('priceTagAppSkus', JSON.stringify(state.allSkus));
                localStorage.setItem('priceTagAppLogo', state.companyLogo);
            };

            /**
             * Loads state from localStorage.
             */
            const loadState = () => {
                const users = localStorage.getItem('priceTagAppUsers');
                const skus = localStorage.getItem('priceTagAppSkus');
                const logs = localStorage.getItem('priceTagAppLogs');
                const logo = localStorage.getItem('priceTagAppLogo');
                const sessionUser = sessionStorage.getItem('priceTagAppSession');

                if (users) {
                    state.users = JSON.parse(users);
                } else {
                    // Default users
                    state.users = [
                        { username: 'host1', password: 'host123', role: ROLES.HOST },
                        { username: 'admin1', password: 'admin123', role: ROLES.ADMIN },
                        { username: 'user1', password: 'u1pass', role: ROLES.USER1 },
                        { username: 'user2', password: 'u2pass', role: ROLES.USER2 },
                        { username: 'user3', password: 'u3pass', role: ROLES.USER3 },
                        { username: 'user4', password: 'u4pass', role: ROLES.USER4 },
                    ];
                }

                if (skus) state.allSkus = JSON.parse(skus);
                if (logs) state.logs = JSON.parse(logs);
                if (logo && logo !== 'null') {
                    state.companyLogo = logo;
                    DOMElements.logoPreviewImg.src = logo;
                }

                if (sessionUser) {
                    const user = JSON.parse(sessionUser);
                    // Find the full user object to get permissions
                    const fullUser = state.users.find(u => u.username === user.username);
                    if(fullUser) {
                        login(fullUser.username, fullUser.password, true);
                    }
                }
            };
            
            // --- 5. CORE APPLICATION LOGIC ---

            /**
             * Handles user login.
             * @param {string} username
             * @param {string} password
             * @param {boolean} isSessionLogin - True if logging in from a stored session.
             */
            const login = (username, password, isSessionLogin = false) => {
                const user = state.users.find(u => u.username === username && u.password === password);
                if (user) {
                    state.currentUser = user;
                    DOMElements.loginScreen.classList.add('hidden');
                    DOMElements.app.classList.remove('hidden');
                    DOMElements.loginError.textContent = '';
                    sessionStorage.setItem('priceTagAppSession', JSON.stringify(user));
                    if (!isSessionLogin) {
                        logAction(`User logged in.`);
                    }
                    setupUIForUser();
                } else {
                    DOMElements.loginError.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                }
            };
            
            /**
             * Handles user logout.
             */
            const logout = () => {
                logAction(`User logged out.`);
                state.currentUser = null;
                sessionStorage.removeItem('priceTagAppSession');
                DOMElements.loginScreen.classList.remove('hidden');
                DOMElements.app.classList.add('hidden');
                DOMElements.usernameInput.value = '';
                DOMElements.passwordInput.value = '';
            };

            /**
             * Sets up the UI based on the current user's role and permissions.
             */
            const setupUIForUser = () => {
                if (!state.currentUser) return;
                const permissions = PERMISSIONS[state.currentUser.role];
                
                // User Info
                DOMElements.userInfo.innerHTML = `
                    <div class="font-semibold">${state.currentUser.username}</div>
                    <div class="text-sm text-gray-400">${state.currentUser.role}</div>
                `;

                // Channel Select
                DOMElements.channelSelect.innerHTML = permissions.visibleChannels
                    .map(ch => `<option value="${ch}">${ch}</option>`)
                    .join('');
                DOMElements.channelSelect.value = 'Flagship'; // Default

                // GP% Column
                const showGp = permissions.showGp && (state.currentUser.role === ROLES.USER3 || state.currentUser.role === ROLES.USER4 || state.currentUser.role === ROLES.ADMIN || state.currentUser.role === ROLES.HOST);
                DOMElements.gpHeader.classList.toggle('hidden', !showGp);

                // Buttons
                const canManageSettings = permissions.canManageSettings;
                DOMElements.settingsBtn.classList.toggle('hidden', !canManageSettings);
                DOMElements.addSkuBtn.classList.toggle('hidden', !canManageSettings);

                renderTable();
            };
            
            /**
             * Renders the main product table based on current filters and pagination.
             */
            const renderTable = () => {
                if (!state.currentUser) return;

                const permissions = PERMISSIONS[state.currentUser.role];
                const searchTerm = DOMElements.searchInput.value.toLowerCase();
                const selectedDate = DOMElements.dateFilter.value;
                const selectedChannel = DOMElements.channelSelect.value;
                
                // Apply filters
                state.filteredSkus = state.allSkus.filter(sku => {
                    const nameMatch = sku.description.toLowerCase().includes(searchTerm);
                    const skuMatch = sku.itemNo.toLowerCase().includes(searchTerm);
                    const dateMatch = !selectedDate || (sku.lastModified && sku.lastModified.startsWith(selectedDate));
                    return (nameMatch || skuMatch) && dateMatch;
                });

                // Pagination logic
                const totalPages = Math.ceil(state.filteredSkus.length / state.itemsPerPage);
                state.currentPage = Math.max(1, Math.min(state.currentPage, totalPages));
                const startIndex = (state.currentPage - 1) * state.itemsPerPage;
                const endIndex = startIndex + state.itemsPerPage;
                const pageItems = state.filteredSkus.slice(startIndex, endIndex);

                // Render table rows
                DOMElements.productTableBody.innerHTML = pageItems.map((sku, index) => {
                    const channelPrice = getChannelPrice(sku, selectedChannel);
                    const gpValue = getGpForChannel(sku, selectedChannel);
                    
                    return `
                        <tr data-sku="${sku.itemNo}">
                            <td class="p-3"><input type="checkbox" class="sku-checkbox" data-sku="${sku.itemNo}"></td>
                            <td class="p-3 font-mono">${sku.itemNo}</td>
                            <td class="p-3 font-semibold">${sku.description}</td>
                            <td class="p-3 text-sm text-gray-400">${(sku.details || '').split('\n').slice(0, 4).join('<br>')}</td>
                            <td class="p-3 text-right">${formatCurrency(sku.normal_price)}</td>
                            <td class="p-3 text-right font-bold text-theme-red">${formatCurrency(channelPrice)}</td>
                            <td class="p-3 text-right">${formatDate(sku.expire_date)}</td>
                            <td class="gp-cell p-3 text-right ${!permissions.showGp || !gpValue ? 'hidden' : ''}">${gpValue ? `${(gpValue * 100).toFixed(1)}%` : '-'}</td>
                            <td class="p-3 text-center">
                                ${permissions.canManageSettings ? `<button class="edit-sku-btn text-blue-400 hover:text-blue-300" data-sku="${sku.itemNo}">แก้ไข</button>` : ''}
                                ${permissions.canManageSettings ? `<button class="delete-sku-btn text-red-500 hover:text-red-400 ml-2" data-sku="${sku.itemNo}">ลบ</button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update pagination info
                DOMElements.pageInfo.textContent = `หน้า ${totalPages > 0 ? state.currentPage : 0} / ${totalPages}`;
                DOMElements.prevPageBtn.disabled = state.currentPage === 1;
                DOMElements.nextPageBtn.disabled = state.currentPage === totalPages;

                // Re-check checkboxes for selected items
                updateCheckboxes();
                updateActionButtons();
            };

            /**
             * Gets the price for a specific channel, applying fallback rules.
             * @param {object} sku The SKU object.
             * @param {string} channel The selected channel.
             * @returns {number} The final price.
             */
            const getChannelPrice = (sku, channel) => {
                const promo = sku.promo_price;
                const normal = sku.normal_price;

                switch (channel) {
                    case 'Flagship':
                        return sku.flagship_price || promo || normal;
                    case 'Dealer':
                        // Assuming the first dealer price for simplicity. A more complex logic could be implemented.
                        return sku.dealer_price || promo || normal;
                    case 'Marketplace':
                        return sku.marketplace_price || promo || normal;
                    default:
                        return promo || normal;
                }
            };
            
            /**
             * Gets the GP% for a specific channel.
             * @param {object} sku The SKU object.
             * @param {string} channel The selected channel.
             * @returns {number | null} The GP percentage or null.
             */
            const getGpForChannel = (sku, channel) => {
                if (channel === 'Dealer') return sku.dealer_gp;
                if (channel === 'Marketplace') return sku.marketplace_gp;
                return null;
            };

            // --- 6. EVENT HANDLERS & LISTENERS ---

            const setupEventListeners = () => {
                DOMElements.loginBtn.addEventListener('click', () => login(DOMElements.usernameInput.value, DOMElements.passwordInput.value));
                DOMElements.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') login(DOMElements.usernameInput.value, DOMElements.passwordInput.value);
                });
                DOMElements.logoutBtn.addEventListener('click', logout);

                // Main controls
                DOMElements.searchInput.addEventListener('input', renderTable);
                DOMElements.dateFilter.addEventListener('change', renderTable);
                DOMElements.channelSelect.addEventListener('change', renderTable);

                // Pagination
                DOMElements.prevPageBtn.addEventListener('click', () => {
                    if (state.currentPage > 1) {
                        state.currentPage--;
                        renderTable();
                    }
                });
                DOMElements.nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(state.filteredSkus.length / state.itemsPerPage);
                    if (state.currentPage < totalPages) {
                        state.currentPage++;
                        renderTable();
                    }
                });

                // Checkbox handling
                DOMElements.selectAllCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const pageSkus = state.filteredSkus.slice((state.currentPage - 1) * state.itemsPerPage, state.currentPage * state.itemsPerPage).map(s => s.itemNo);
                    
                    pageSkus.forEach(sku => {
                        if (isChecked) {
                            state.selectedSkus.add(sku);
                        } else {
                            state.selectedSkus.delete(sku);
                        }
                    });
                    updateCheckboxes();
                    updateActionButtons();
                });

                DOMElements.productTableBody.addEventListener('change', (e) => {
                    if (e.target.classList.contains('sku-checkbox')) {
                        const sku = e.target.dataset.sku;
                        if (e.target.checked) {
                            state.selectedSkus.add(sku);
                        } else {
                            state.selectedSkus.delete(sku);
                        }
                        updateActionButtons();
                    }
                });
                
                // Action buttons
                DOMElements.previewBtn.addEventListener('click', () => showPreviewModal(Array.from(state.selectedSkus)));
                DOMElements.printBtn.addEventListener('click', () => handlePrint(Array.from(state.selectedSkus)));
                DOMElements.exportPdfBtn.addEventListener('click', () => handleExportPdf(Array.from(state.selectedSkus)));

                // SKU Modal
                DOMElements.addSkuBtn.addEventListener('click', () => showSkuModal());
                DOMElements.productTableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('edit-sku-btn')) {
                        showSkuModal(e.target.dataset.sku);
                    }
                    if (e.target.classList.contains('delete-sku-btn')) {
                        deleteSku(e.target.dataset.sku);
                    }
                });
                DOMElements.skuForm.addEventListener('submit', handleSkuFormSubmit);
                DOMElements.cancelSkuBtn.addEventListener('click', () => DOMElements.skuModal.style.display = 'none');
                
                // Settings Modal
                DOMElements.settingsBtn.addEventListener('click', showSettingsPanel);
                DOMElements.closeSettingsBtn.addEventListener('click', () => DOMElements.settingsPanel.style.display = 'none');
                DOMElements.importExcel.addEventListener('change', handleExcelImport);
                DOMElements.exportExcelBtn.addEventListener('click', handleExcelExport);
                DOMElements.clearDataBtn.addEventListener('click', clearAllData);
                DOMElements.importLogo.addEventListener('change', handleLogoImport);
                DOMElements.addUserForm.addEventListener('submit', handleAddUser);
                DOMElements.userTableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-user-btn')) {
                        deleteUser(e.target.dataset.username);
                    }
                });
                DOMElements.exportLogsCsvBtn.addEventListener('click', exportLogsToCsv);
                
                // Preview Modal
                DOMElements.closePreviewBtn.addEventListener('click', () => DOMElements.previewModal.style.display = 'none');
            };
            
            const updateCheckboxes = () => {
                document.querySelectorAll('.sku-checkbox').forEach(cb => {
                    cb.checked = state.selectedSkus.has(cb.dataset.sku);
                });
            };

            const updateActionButtons = () => {
                const hasSelection = state.selectedSkus.size > 0;
                DOMElements.previewBtn.disabled = !hasSelection;
                DOMElements.printBtn.disabled = !hasSelection;
                DOMElements.exportPdfBtn.disabled = !hasSelection;
            };

            // --- 7. SKU & DATA MANAGEMENT FUNCTIONS ---
            
            const showSkuModal = (skuId = null) => {
                DOMElements.skuForm.reset();
                // The case for editing an existing SKU
                if (skuId) {
                    const sku = state.allSkus.find(s => s.itemNo === skuId);
                    // Guard clause in case the SKU isn't found
                    if (!sku) {
                        console.error(`Attempted to edit non-existent SKU: ${skuId}`);
                        return;
                    }
                    DOMElements.skuModalTitle.textContent = 'แก้ไขข้อมูลสินค้า';
                    DOMElements.skuForm.querySelector('#sku-id').value = skuId;
                    DOMElements.skuForm.querySelector('#sku-itemNo').value = sku.itemNo;
                    DOMElements.skuForm.querySelector('#sku-itemNo').readOnly = true;
                    DOMElements.skuForm.querySelector('#sku-description').value = sku.description;
                    DOMElements.skuForm.querySelector('#sku-details').value = sku.details;
                    DOMElements.skuForm.querySelector('#sku-normal_price').value = sku.normal_price;
                    DOMElements.skuForm.querySelector('#sku-promo_price').value = sku.promo_price;
                    DOMElements.skuForm.querySelector('#sku-flagship_price').value = sku.flagship_price;
                    DOMElements.skuForm.querySelector('#sku-dealer_price').value = sku.dealer_price;
                    DOMElements.skuForm.querySelector('#sku-marketplace_price').value = sku.marketplace_price;
                    DOMElements.skuForm.querySelector('#sku-expire_date').value = sku.expire_date;
                } 
                // The case for adding a new SKU
                else {
                    DOMElements.skuModalTitle.textContent = 'เพิ่มสินค้าใหม่';
                    DOMElements.skuForm.querySelector('#sku-id').value = '';
                    DOMElements.skuForm.querySelector('#sku-itemNo').readOnly = false;
                }
                DOMElements.skuModal.style.display = 'flex';
            };

            const handleSkuFormSubmit = (e) => {
                e.preventDefault();
                const skuId = DOMElements.skuForm.querySelector('#sku-id').value;
                const formData = new FormData(DOMElements.skuForm);
                const newSkuData = {
                    itemNo: DOMElements.skuForm.querySelector('#sku-itemNo').value,
                    description: DOMElements.skuForm.querySelector('#sku-description').value,
                    details: DOMElements.skuForm.querySelector('#sku-details').value,
                    normal_price: parseFloat(DOMElements.skuForm.querySelector('#sku-normal_price').value) || null,
                    promo_price: parseFloat(DOMElements.skuForm.querySelector('#sku-promo_price').value) || null,
                    flagship_price: parseFloat(DOMElements.skuForm.querySelector('#sku-flagship_price').value) || null,
                    dealer_price: parseFloat(DOMElements.skuForm.querySelector('#sku-dealer_price').value) || null,
                    marketplace_price: parseFloat(DOMElements.skuForm.querySelector('#sku-marketplace_price').value) || null,
                    expire_date: DOMElements.skuForm.querySelector('#sku-expire_date').value,
                    lastModified: new Date().toISOString().split('T')[0],
                };
                
                if (skuId) { // Editing existing SKU
                    const index = state.allSkus.findIndex(s => s.itemNo === skuId);
                    state.allSkus[index] = { ...state.allSkus[index], ...newSkuData };
                    logAction(`Edited SKU: ${skuId}`);
                } else { // Adding new SKU
                    if (state.allSkus.some(s => s.itemNo === newSkuData.itemNo)) {
                        alert('SKU นี้มีอยู่ในระบบแล้ว');
                        return;
                    }
                    state.allSkus.unshift(newSkuData);
                    logAction(`Added new SKU: ${newSkuData.itemNo}`);
                }
                
                saveState();
                renderTable();
                DOMElements.skuModal.style.display = 'none';
            };

            const deleteSku = (skuId) => {
                if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบ SKU: ${skuId}?`)) {
                    state.allSkus = state.allSkus.filter(s => s.itemNo !== skuId);
                    state.selectedSkus.delete(skuId);
                    logAction(`Deleted SKU: ${skuId}`);
                    saveState();
                    renderTable();
                }
            };
            
            const handleExcelImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Find header row and map columns
                    const headerRowIndex = json.findIndex(row => row.includes('Item No.'));
                    if (headerRowIndex === -1) {
                        alert('ไม่พบ Header "Item No." ในไฟล์ Excel');
                        return;
                    }
                    const headers = json[headerRowIndex];
                    const dataRows = json.slice(headerRowIndex + 1);
                    
                    const colMap = {
                        itemNo: headers.indexOf('Item No.'),
                        description: headers.indexOf('Description'),
                        details: headers.indexOf('Details'),
                        normal_price: headers.indexOf('Normal Price'),
                        promo_price: headers.indexOf('Promotion Price'),
                        flagship_price: headers.indexOf('Flagship Price / Website'),
                        dealer_price: headers.indexOf('Dealer Price'),
                        marketplace_price: headers.indexOf('Marketplace Price'),
                        expire_date: headers.indexOf('Expire Date'),
                        marketplace_gp: headers.indexOf('GP%'), // Assuming this GP is for marketplace
                        dealer_gp: headers.indexOf('GP %'), // Assuming this is for dealer
                    };
                    
                    const importedSkus = dataRows.map(row => {
                        // Excel dates can be numbers, convert them
                        let expireDate = row[colMap.expire_date];
                        if (typeof expireDate === 'number') {
                            const jsDate = new Date(Math.round((expireDate - 25569) * 864e5));
                            expireDate = jsDate.toISOString().split('T')[0];
                        } else if (expireDate instanceof Date) {
                            expireDate = expireDate.toISOString().split('T')[0];
                        }

                        return {
                            itemNo: row[colMap.itemNo] || '',
                            description: row[colMap.description] || '',
                            details: row[colMap.details] || '',
                            normal_price: parseFloat(row[colMap.normal_price]) || null,
                            promo_price: parseFloat(row[colMap.promo_price]) || null,
                            flagship_price: parseFloat(row[colMap.flagship_price]) || null,
                            dealer_price: parseFloat(row[colMap.dealer_price]) || null,
                            marketplace_price: parseFloat(row[colMap.marketplace_price]) || null,
                            expire_date: expireDate || null,
                            marketplace_gp: parseFloat(row[colMap.marketplace_gp]) || null,
                            dealer_gp: parseFloat(row[colMap.dealer_gp]) || null,
                            lastModified: new Date().toISOString().split('T')[0],
                        };
                    }).filter(sku => sku.itemNo); // Filter out empty rows

                    state.allSkus = importedSkus;
                    logAction(`Imported ${importedSkus.length} SKUs from Excel.`);
                    saveState();
                    renderTable();
                    alert(`นำเข้าข้อมูล ${importedSkus.length} รายการสำเร็จ!`);
                };
                reader.readAsArrayBuffer(file);
            };

            const handleExcelExport = () => {
                const dataToExport = state.allSkus.map(sku => ({
                    'Item No.': sku.itemNo,
                    'Description': sku.description,
                    'Details': sku.details,
                    'Normal Price': sku.normal_price,
                    'Promotion Price': sku.promo_price,
                    'Flagship Price / Website': sku.flagship_price,
                    'Dealer Price': sku.dealer_price,
                    'Marketplace Price': sku.marketplace_price,
                    'Expire Date': sku.expire_date ? formatDate(sku.expire_date) : '',
                    'Marketplace GP%': sku.marketplace_gp,
                    'Dealer GP%': sku.dealer_gp,
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
                XLSX.writeFile(workbook, "PriceTagData_Export.xlsx");
                logAction('Exported data to Excel.');
            };

            const clearAllData = () => {
                if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลสินค้าทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                    state.allSkus = [];
                    state.selectedSkus.clear();
                    logAction('Cleared all SKU data.');
                    saveState();
                    renderTable();
                }
            };
            
            // --- 8. SETTINGS & USER MANAGEMENT ---

            const showSettingsPanel = () => {
                renderSettingsTabs();
                renderUserTable();
                renderLogs();
                DOMElements.settingsPanel.style.display = 'flex';
            };

            const renderSettingsTabs = () => {
                const permissions = PERMISSIONS[state.currentUser.role];
                const tabs = [
                    { id: 'data-management', label: 'จัดการข้อมูล', show: true },
                    { id: 'logo-management', label: 'จัดการโลโก้', show: true },
                    { id: 'user-management', label: 'จัดการผู้ใช้งาน', show: permissions.canManageUsers },
                    { id: 'logs', label: 'ประวัติการใช้งาน', show: true },
                ];

                DOMElements.settingsTabs.innerHTML = tabs
                    .filter(tab => tab.show)
                    .map((tab, index) => `
                        <a href="#" data-tab="${tab.id}-tab" class="settings-tab-btn ${index === 0 ? 'text-theme-red border-b-2 border-theme-red' : 'text-gray-400'} px-3 py-2 font-medium text-sm rounded-t-lg">${tab.label}</a>
                    `).join('');
                
                // Add click listeners to new tabs
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        // Hide all content
                        DOMElements.settingsContent.querySelectorAll(':scope > div').forEach(div => div.classList.add('hidden'));
                        // Deactivate all tabs
                        document.querySelectorAll('.settings-tab-btn').forEach(b => {
                            b.classList.remove('text-theme-red', 'border-b-2', 'border-theme-red');
                            b.classList.add('text-gray-400');
                        });
                        // Show selected content
                        document.getElementById(e.target.dataset.tab).classList.remove('hidden');
                        // Activate selected tab
                        e.target.classList.add('text-theme-red', 'border-b-2', 'border-theme-red');
                        e.target.classList.remove('text-gray-400');
                    });
                });
                
                // Show first tab by default
                DOMElements.settingsContent.querySelectorAll(':scope > div').forEach(div => div.classList.add('hidden'));
                document.getElementById('data-management-tab').classList.remove('hidden');
            };
            
            const handleLogoImport = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.companyLogo = e.target.result;
                        DOMElements.logoPreviewImg.src = state.companyLogo;
                        saveState();
                        logAction('Updated company logo.');
                    };
                    reader.readAsDataURL(file);
                }
            };

            const renderUserTable = () => {
                if (!PERMISSIONS[state.currentUser.role].canManageUsers) return;
                DOMElements.userTableBody.innerHTML = state.users.map(user => `
                    <tr>
                        <td class="p-2">${user.username}</td>
                        <td class="p-2">${user.role}</td>
                        <td class="p-2 text-xs">${PERMISSIONS[user.role].visibleChannels.join(', ')}</td>
                        <td class="p-2">
                            ${user.role !== ROLES.HOST ? `<button class="delete-user-btn text-red-500 hover:text-red-400" data-username="${user.username}">ลบ</button>` : ''}
                        </td>
                    </tr>
                `).join('');
                
                DOMElements.newRoleSelect.innerHTML = Object.values(ROLES).map(r => `<option value="${r}">${r}</option>`).join('');
            };

            const handleAddUser = (e) => {
                e.preventDefault();
                const username = document.getElementById('new-username').value;
                const password = document.getElementById('new-password').value;
                const role = document.getElementById('new-role').value;

                if (!username || !password) {
                    alert('กรุณากรอกชื่อผู้ใช้และรหัสผ่าน');
                    return;
                }
                if (state.users.some(u => u.username === username)) {
                    alert('ชื่อผู้ใช้นี้มีอยู่แล้ว');
                    return;
                }

                state.users.push({ username, password, role });
                logAction(`Added new user: ${username} with role ${role}.`);
                saveState();
                renderUserTable();
                e.target.reset();
            };

            const deleteUser = (username) => {
                if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้: ${username}?`)) {
                    state.users = state.users.filter(u => u.username !== username);
                    logAction(`Deleted user: ${username}.`);
                    saveState();
                    renderUserTable();
                }
            };
            
            const renderLogs = () => {
                DOMElements.logsContainer.innerHTML = state.logs.map(log => 
                    `<div><span class="text-green-400">${log.timestamp}</span> <span class="text-yellow-400">[${log.user}]</span>: ${log.action}</div>`
                ).join('');
            };

            const exportLogsToCsv = () => {
                let csvContent = "data:text/csv;charset=utf-8,Timestamp,User,Action\n";
                state.logs.forEach(log => {
                    csvContent += `"${log.timestamp}","${log.user}","${log.action}"\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "activity_logs.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- 9. PRINTING & PDF EXPORT ---

            const renderTag = (sku, template) => {
                if (!sku) return '';
                const channel = DOMElements.channelSelect.value;
                const price = getChannelPrice(sku, channel);
                const normalPrice = sku.normal_price;
                const hasPromo = sku.promo_price && sku.promo_price < normalPrice;

                const logoHtml = state.companyLogo 
                    ? `<img src="${state.companyLogo}" class="logo-img" alt="Company Logo">`
                    : `<div class="logo-text">ProPlugin<br>AMPLIFY YOUR DREAMS</div>`;
                
                const priceHtml = `
                    ${hasPromo ? `<div class="normal-price">${formatCurrency(normalPrice)}.-</div>` : ''}
                    <div class="${hasPromo ? 'promo-price' : 'main-price'}">${formatCurrency(price)}.-</div>
                `;

                const detailsHtml = (sku.details || '')
                    .split('\n')
                    .filter(line => line.trim() !== '')
                    .slice(0, 5)
                    .map(line => `<li>${line.startsWith('•') ? line.substring(1).trim() : line}</li>`)
                    .join('');
                
                const expireDateHtml = sku.expire_date ? `<div class="expire-date">Expire : ${formatDate(sku.expire_date)}</div>` : '';

                if (template === 'Acc') {
                    return `
                        <div class="price-tag acc-content">
                            <div class="logo-container">${logoHtml}</div>
                            <div class="sku">${sku.itemNo}</div>
                            <div class="description">${sku.description}</div>
                            <div class="price-area">
                                ${expireDateHtml}
                                ${priceHtml}
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="price-tag">
                        <div class="inner-content">
                            <div class="logo-container">${logoHtml}</div>
                            <div class="sku">${sku.itemNo}</div>
                            <div class="description">${sku.description}</div>
                            <ul class="details">${detailsHtml}</ul>
                            <div class="price-area">
                                ${expireDateHtml}
                                ${priceHtml}
                            </div>
                        </div>
                    </div>
                `;
            };

            const showPreviewModal = (skuIds) => {
                if (skuIds.length === 0) return;
                let currentIndex = 0;
                
                const renderPreview = () => {
                    const skuId = skuIds[currentIndex];
                    const sku = state.allSkus.find(s => s.itemNo === skuId);
                    const template = DOMElements.templateSelect.value;
                    const containerClass = `tag-container-${template.toLowerCase()}`;
                    
                    DOMElements.previewContent.innerHTML = `
                        <div class="${containerClass}" style="transform: scale(0.8);">
                            ${renderTag(sku, template)}
                        </div>
                    `;
                    DOMElements.previewIndexInfo.textContent = `${currentIndex + 1} / ${skuIds.length}`;
                };

                DOMElements.prevPreviewBtn.onclick = () => {
                    if (currentIndex > 0) {
                        currentIndex--;
                        renderPreview();
                    }
                };
                DOMElements.nextPreviewBtn.onclick = () => {
                    if (currentIndex < skuIds.length - 1) {
                        currentIndex++;
                        renderPreview();
                    }
                };
                
                renderPreview();
                DOMElements.previewModal.style.display = 'flex';
            };

            const handlePrint = (skuIds) => {
                if (skuIds.length === 0) return;
                preparePrintArea(skuIds);
                logAction(`Printed ${skuIds.length} tags with template ${DOMElements.templateSelect.value}.`);
                setTimeout(() => window.print(), 500); // Allow time for render
            };
            
            const preparePrintArea = (skuIds) => {
                const template = DOMElements.templateSelect.value;
                const skus = skuIds.map(id => state.allSkus.find(s => s.itemNo === id));
                const itemsPerPageMap = { 'A4': 1, 'A5': 2, 'A6': 4, 'Acc': 12 };
                const itemsPerPage = itemsPerPageMap[template];
                
                DOMElements.printArea.innerHTML = '';
                
                for (let i = 0; i < skus.length; i += itemsPerPage) {
                    const pageSkus = skus.slice(i, i + itemsPerPage);
                    const page = document.createElement('div');
                    page.className = `print-page grid-${template.toLowerCase()}`;
                    
                    page.innerHTML = pageSkus.map(sku => `
                        <div class="tag-container-${template.toLowerCase()}">
                            ${renderTag(sku, template)}
                        </div>
                    `).join('');
                    
                    // Add blank placeholders to fill the page grid
                    const placeholdersNeeded = itemsPerPage - pageSkus.length;
                    for (let j = 0; j < placeholdersNeeded; j++) {
                        page.innerHTML += `<div class="tag-container-${template.toLowerCase()}"></div>`;
                    }

                    DOMElements.printArea.appendChild(page);
                }
            };
            
            async function handleExportPdf(skuIds) {
                if (skuIds.length === 0) return;
                
                preparePrintArea(skuIds);
                logAction(`Exported ${skuIds.length} tags to PDF with template ${DOMElements.templateSelect.value}.`);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pages = DOMElements.printArea.querySelectorAll('.print-page');
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    await html2canvas(page, {
                        scale: 3, // Higher scale for better quality
                        useCORS: true,
                        logging: false,
                    }).then(canvas => {
                        if (i > 0) {
                            pdf.addPage();
                        }
                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                    });
                }
                pdf.save(`PriceTags-${DOMElements.templateSelect.value}.pdf`);
            }

            // --- 10. INITIALIZATION ---

            const initializeApp = () => {
                loadState();
                if (!state.currentUser) {
                    DOMElements.loginScreen.classList.remove('hidden');
                    DOMElements.app.classList.add('hidden');
                }
                setupEventListeners();
            };

            initializeApp();
        });
    </script>

</body>
</html>
